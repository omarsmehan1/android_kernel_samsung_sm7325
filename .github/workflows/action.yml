name: Full Kernel Build (GKI + KSU)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "a73xq"
        type: choice
        options:
          - a73xq
          - a52sxq
          - m52xq

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      SRC_DIR: ${{ github.workspace }}
      OUT_DIR: ${{ github.workspace }}/out
      TC_DIR: ${{ github.workspace }}/toolchains
      ANYKERNEL: ${{ github.workspace }}/AnyKernel3
      JOBS: ${{ runner.cores }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y git device-tree-compiler lz4 xz-utils zlib1g-dev openjdk-17-jdk gcc g++ \
            python3 python-is-python3 p7zip-full android-sdk-libsparse-utils erofs-utils \
            default-jdk gnupg flex bison gperf build-essential zip curl libc6-dev \
            libncurses-dev libx11-dev libreadline-dev libgl1 libgl1-mesa-dev make bc \
            grep tofrodos python3-markdown libxml2-utils xsltproc zlib1g-dev libtinfo6 \
            make repo cpio kmod openssl libelf-dev pahole libssl-dev libarchive-tools zstd rsync --fix-missing
          wget http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
          sudo dpkg -i libtinfo5_6.3-2ubuntu0.1_amd64.deb
          rm -f libtinfo5_6.3-2ubuntu0.1_amd64.deb

      - name: Install Clang
        run: |
          CLANGVER="clang-r530567"
          CLANG_DIR="$TC_DIR/$CLANGVER"
          CLANG_BIN="$CLANG_DIR/bin"
          mkdir -p "$CLANG_DIR"
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/$CLANGVER.tar.gz -O "$TC_DIR/$CLANGVER.tar.gz"
          tar xf "$TC_DIR/$CLANGVER.tar.gz" -C "$CLANG_DIR"
          rm "$TC_DIR/$CLANGVER.tar.gz"
          echo "$CLANG_BIN" >> $GITHUB_PATH

      - name: Fetch AnyKernel3
        run: |
          if [[ ! -d "$ANYKERNEL" ]]; then
            git clone https://github.com/osm0sis/AnyKernel3.git "$ANYKERNEL"
          fi

      - name: Build Kernel GKI
        run: |
          git switch main
          DEVICE="${{ github.event.inputs.device }}"
          OUT="$OUT_DIR/gki"
          mkdir -p "$OUT"
          export ARCH=arm64
          export LLVM=1
          make -j$JOBS O="$OUT" rio_defconfig
          make -j$JOBS O="$OUT"
          
          # Prepare AnyKernel3
          PKG="$OUT_DIR/gki_pkg"
          mkdir -p "$PKG"
          cp "$OUT/arch/arm64/boot/Image" "$PKG/Image"
          cp "$OUT/arch/arm64/boot/dtbo.img" "$PKG/dtbo.img"
          cp "$OUT/arch/arm64/boot/dts/vendor/qcom/yupik.dtb" "$PKG/dtb"
          cp -r "$ANYKERNEL"/* "$PKG/"
          sed -i '/flash_boot()/,/}/c\
flash_boot() {\
    write_boot "$1/Image" "$2";\
    write_boot "$1/dtbo.img" "$2";\
    write_boot "$1/dtb" "$2";\
}' "$PKG/anykernel.sh"
          cd "$PKG"
          zip -r "../RIO_GKI_${DEVICE}.zip" *
          cd "$SRC_DIR"

      - name: Build Kernel KSU
        run: |
          git switch susfs-rio
          DEVICE="${{ github.event.inputs.device }}"
          OUT="$OUT_DIR/ksu"
          mkdir -p "$OUT"
          
          # Run external KSU setup
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin

          export ARCH=arm64
          export LLVM=1
          make -j$JOBS O="$OUT" rio_defconfig
          make -j$JOBS O="$OUT"

          # Prepare AnyKernel3
          PKG="$OUT_DIR/ksu_pkg"
          mkdir -p "$PKG"
          cp "$OUT/arch/arm64/boot/Image" "$PKG/Image"
          cp "$OUT/arch/arm64/boot/dtbo.img" "$PKG/dtbo.img"
          cp "$OUT/arch/arm64/boot/dts/vendor/qcom/yupik.dtb" "$PKG/dtb"
          cp -r "$ANYKERNEL"/* "$PKG/"
          sed -i '/flash_boot()/,/}/c\
flash_boot() {\
    write_boot "$1/Image" "$2";\
    write_boot "$1/dtbo.img" "$2";\
    write_boot "$1/dtb" "$2";\
}' "$PKG/anykernel.sh"
          cd "$PKG"
          zip -r "../RIO_KSU_${DEVICE}.zip" *
          cd "$SRC_DIR"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Packages-${{ github.event.inputs.device }}
          path: |
            ${{ github.workspace }}/out/*/*.zip
